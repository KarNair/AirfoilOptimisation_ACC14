#cloud-config

apt_update: true
apt_upgrade: true

packages:
 - python3-pip
 - python3-dev
 - build-essential

byobu_default: system 

runcmd:
 - sudo apt-get update
 - sudo apt-get install python3-pip
 - pip3 install flask
 - pip3 install celery
 - sudo apt install rabbitmq-server
 - sudo rabbitmqctl add_user acc14 accg14
 - sudo rabbitmqctl add_vhost g14host
 - sudo rabbitmqctl set_permissions -p g14host acc14 ".*" ".*" ".*"
 - sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg | apt-key add -
 - sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
 - sudo apt-cache policy docker-ce
 - sudo apt-get install -y docker-ce
 - sudo docker run -td -v $(pwd):/home/fenics/shared -w /home/fenics/shared quay.io/fenicsproject/stable:current
 - sudo git clone https://github.com/KarNair/AirfoilOptimisation_ACC14.git  
 - cd AirfoilOptimisation_ACC14/src/python
 - sudo service rabbitmq-server stop 
 - sudo service rabbitmq-server start 
 - python3 flask_airfoil_tasks.py
# - curl -i http://130.238.xx.xx:5000/airfoil/api/base?input=1,1,1,1
